#!/usr/bin/env bash

# Starts the Hadoop data node. Expects the name node host and the daemon flag
# as parameters

source /etc/bash.bashrc

export $HADOOP_HOME=/usr/local/hadoop-2.8.2
export $HADOOP_CONF_DIR=$HADOOP_HOME/etc/hadoop

if [[ -z "${1}" ]]; then
  echo "Name node host not specified" >&2
  exit 1
fi
# Wait for the name node to be online
while ! nc -z $1 50070; do
  sleep 2;
done;
# Start HDFS data node
sed -i.bak "s|\[NAMENODE_HOST\]|${1}|g" $HADOOP_CONF_DIR/core-site.xml
rm -f $HADOOP_CONF_DIR/core-site.xml.bak
$HADOOP_HOME/sbin/hadoop-daemon.sh start datanode
# Start daemon if specified
if [[ "${2}" != 'daemon' ]]; then
  sleep infinity
fi
